import os
import time
import streamlit as st
import pandas as pd
import joblib
from datetime import datetime
import re
from pathlib import Path
import base64
import requests
import project_1.ui_mini1.mini1_promo_email as promo_email

def get_abs_path(relative_path):
    """상대 경로를 절대 경로로 변환"""
    return Path(__file__).parent.parent / relative_path

# 모델과 출시 년월 데이터
launch_dates = {
    '현대': {
        'G70 (IK)': '2017-09',
        'NEXO (FE)': '2018-01',
        'Avante (CN7 N)': '2020-05',
        'G80 (RG3)': '2020-03',
        'Grandeur (GN7 HEV)': '2022-01',
        'Tucson (NX4 PHEV)': '2021-05',
        'Avante (CN7 HEV)': '2020-07',
        'IONIQ 6 (CE)': '2022-06',
        'G90 (HI)': '2022-03',
        'Santa-Fe (MX5 PHEV)': '2022-06'
    },
    '기아': {
        'K3': '2018-09',
        'EV6': '2021-03',
        'K5': '2019-12',
        'Telluride': '2019-01',
        'Seltos': '2019-06',
        'Sorento': '2020-03',
        'Carnival': '2020-06',
        'Sportage': '2021-06',
        'EV9': '2023-03'
    }
}

# 친환경차 모델 목록
eco_friendly_models = {
    '현대': [
        'NEXO (FE)', 'Avante (CN7 HEV)', 'Grandeur (GN7 HEV)', 
        'Tucson (NX4 PHEV)', 'IONIQ 6 (CE)', 'Santa-Fe (MX5 PHEV)'
    ],
    '기아': ['EV6', 'EV9']
}

# 클러스터별 차량 추천 모델 목록
brand_recommendations = {
    '현대': {
        0: ['Avante (CN7 N)', "G70 (IK)", "Tucson (NX4 PHEV)"],
        1: ["IONIQ 6 (CE)", "Grandeur (GN7 HEV)", "NEXO (FE)"],
        2: ["IONIQ 6 (CE)", "Grandeur (GN7 HEV)", "Santa-Fe (MX5 PHEV)"],
        3: ['Avante (CN7 N)', "Tucson (NX4 PHEV)", "G90 (HI)"],
        4: ["IONIQ 6 (CE)", "Santa-Fe (MX5 PHEV)", "Tucson (NX4 PHEV)"],
        5: ["Avante (CN7 N)", "G70 (IK)", "Tucson (NX4 PHEV)"]
    },
    '기아': {
        0: ["K5", "Telluride", "Sportage"],
        1: ["EV9", "Sorento", "Carnival"],
        2: ["K5", "EV6", "Seltos"],
        3: ["K5", "Sportage", "Tucson(NX4)"],
        4: ["Telluride", "EV9", "Sorento"],
        5: ["K5", "K3", "Sonet"]
    }
}

# 차량 이미지 경로
IMAGE_BASE_PATH = 'img/'
vehicle_images = {
    model: get_abs_path(f"{IMAGE_BASE_PATH}{model}.png")
    for brand_models in launch_dates.values()
    for model in brand_models
}

# 차량 링크 매핑
vehicle_links = {
    "현대": {
        "Avante (CN7 N)": "https://www.hyundai.com/kr/ko/vehicles/avante",
        "NEXO (FE)": "https://www.hyundai.com/kr/ko/vehicles/nexo",
        "G80 (RG3)": "https://www.genesis.com/kr/ko/models/luxury-sedan-genesis/g80-black/highlights.html",
        "G90 (HI)": "https://www.genesis.com/kr/ko/models/luxury-sedan-genesis/g90-black/highlights.html",
        "IONIQ 6 (CE)": "https://www.hyundai.com/kr/ko/e/vehicles/ioniq6/intro",
        "Tucson (NX4 PHEV)": "https://www.hyundai.com/kr/ko/vehicles/tucson",
        "Grandeur (GN7 HEV)": "https://www.hyundai.com/kr/ko/vehicles/grandeur",
        "G70 (IK)": "https://www.genesis.com/kr/ko/models/luxury-sedan-genesis/g70/highlights.html",
        "Santa-Fe (MX5 PHEV)": "https://www.hyundai.com/kr/ko/e/vehicles/santafe/intro",
        "Avante (CN7 HEV)": "https://www.hyundai.com/kr/ko/e/vehicles/avante-n/intro"
    },
    "기아": {
        "K3": "https://www.kia.com/kr/vehicles/k3/summary.html",
        "K5": "https://www.kia.com/kr/vehicles/k5/summary.html",
        "EV6": "https://www.kia.com/kr/vehicles/ev6/summary.html",
        "Telluride": "https://www.kia.com/us/en/telluride",
        "Seltos": "https://www.kia.com/kr/vehicles/seltos/summary.html",
        "Sorento": "https://www.kia.com/kr/vehicles/sorento/summary.html",
        "Carnival": "https://www.kia.com/kr/vehicles/carnival/summary.html",
        "Sportage": "https://www.kia.com/kr/vehicles/sportage/summary.html",
        "EV9": "https://www.kia.com/kr/vehicles/ev9/summary.html"
    }
}

# 클러스터별 차량 추천 이유 매핑 (개선된 버전)
vehicle_recommendations = {
    '현대': {
        "Avante (CN7 N)": {
            0: {
                "title": "🌟 합리적인 선택을 원하는 당신을 위한 Avante CN7 N",
                "specs": {
                    "엔진": "1.6L 가솔린",
                    "연비": "15.2km/L",
                    "출력": "123마력",
                    "트렁크": "475L",
                    "안전등급": "Euro NCAP 5성급"
                },
                "추천이유": [
                    "💰 **가성비 최고**: 동급 최저 유지비 (월 평균 12만원)",
                    "🛡️ **안전 최적화**: 6에어백 + 긴급제동 시스템 기본 탑재",
                    "🚗 **주차 편의**: 후방 카메라 & 후측방 경고 시스템",
                    "🔄 **할부 혜택**: 36개월 무이자 할부 가능"
                ],
                "고객유형": "40~50대 중년층, 첫 차 구매자, 가성비를 중시하는 분",
                "경쟁차종": "기아 K3, 토요타 코롤라 대비 10% 더 낮은 유지비",
                "추천트림": "Smart (가솔린 1.6)",
                "트림가격": "2,475만원",
                "추천옵션": "어반 세이프티 패키지",
                "옵션가격": "132만원",
                "총가격": "2,607만원"
            },
            3: {
                "title": "🛣️ 장거리 운전자에게 딱 맞는 Avante CN7 N 하이웨이 에디션",
                "specs": {
                    "엔진": "1.6L 가솔린",
                    "고속도로 연비": "16.1km/L",
                    "주행보조": "하이웨이 드라이빙 어시스트",
                    "최대주행거리": "890km(풀탱크 기준)",
                    "소음도": "68dB(100km/h 기준)"
                },
                "추천이유": [
                    "🛣️ **장거리 최적화**: 고속도로 주행 시 연비 16.1km/L",
                    "🤖 **스마트 크루즈**: 차간거리 자동 조절로 운전 피로도 30%↓",
                    "💺 **편안한 시트**: 8-way 파워 시트 + 통풍 기능",
                    "🔊 **정숙성**: 동급 최저 수준의 실내 소음"
                ],
                "고객유형": "주말마다 고향을 오가는 분, 자녀 통학용으로 장거리 운전이 많은 분",
                "경쟁차종": "혼다 시빅 대비 12% 더 좋은 고속도로 연비",
                "추천트림": "Modern (가솔린 1.6)",
                "트림가격": "2,350만원",
                "추천옵션": "하이웨이 드라이빙 어시스트",
                "옵션가격": "90만원",
                "총가격": "2,440만원"
            },
            5: {
                "title": "🚘 첫 차 구매자에게 안성맞춤! Avante CN7 N 라이트 에디션",
                "specs": {
                    "엔진": "1.6L 가솔린",
                    "연비": "14.8km/L",
                    "안전사양": "후방카메라 + 긴급제동 기본",
                    "인포테인먼트": "10.25인치 내비게이션",
                    "보증": "5년 무상 A/S"
                },
                "추천이유": [
                    "🆕 **첫 차 특화**: 초보 운전자를 위한 주차 보조 시스템",
                    "📱 **스마트 연결**: 애플 카플레이/안드로이드 오토 기본 지원",
                    "🔧 **유지보수**: 5년 무상 A/S로 관리 비용 절감",
                    "💳 **할부 혜택**: 48개월 무이자 할부 가능"
                ],
                "고객유형": "첫 차를 구매하는 20~30대, 초보 운전자",
                "경쟁차종": "현대 쏘나타 대비 25% 더 저렴한 보험료",
                "추천트림": "Modern (가솔린 1.6)",
                "트림가격": "2,350만원",
                "추천옵션": "라이트 에디션",
                "옵션가격": "65만원",
                "총가격": "2,415만원"
            }
        },
        "G70 (IK)": {
            0: {
                "title": "✨ 프리미엄 감성을 합리적으로! G70 Premium",
                "specs": {
                    "엔진": "2.0L 터보",
                    "출력": "245마력",
                    "가속": "0-100km/h 6.1초",
                    "서스펜션": "전자식 컨트롤 댐퍼",
                    "인테리어": "퀼팅 난나카 가죽 시트"
                },
                "추천이유": [
                    "🏆 **프리미엄 브랜드**: 제네시스의 고급스러움",
                    "🛣️ **주행 안정성**: 19인치 알로이 휠 + 전자식 서스펜션",
                    "📱 **첨단 기술**: 12.3인치 클러스터 + 헤드업 디스플레이",
                    "🛡️ **안전**: 10에어백 + 주행보조시스템 풀패키지"
                ],
                "고객유형": "50대 이상 중년 남성층, BMW 3시리즈 대안을 찾는 분",
                "경쟁차종": "BMW 3시리즈 대비 20% 더 저렴한 가격",
                "추천트림": "Premium (2.0T)",
                "트림가격": "4,250만원",
                "추천옵션": "베이직 플러스 패키지",
                "옵션가격": "95만원",
                "총가격": "4,345만원"
            },
            5: {
                "title": "🆕 첫 프리미엄 차량? G70 Standard로 시작하세요",
                "specs": {
                    "엔진": "2.0L 터보",
                    "출력": "245마력",
                    "주행보조": "후측방 모니터링 + 자동 주차",
                    "인테리어": "고급 가죽 시트",
                    "보증": "3년 무상 유지보스"
                },
                "추천이유": [
                    "💰 **합리적 가격**: 프리미엄 세단의 진입 장벽 낮춤",
                    "🅿️ **주차 편의**: 자동 주차 시스템으로 도심 생활 용이",
                    "👨‍💼 **전담 서비스**: 1:1 전담 상담원 제공",
                    "🔧 **유지보수**: 3년 무상 유지보스로 관리 비용 절감"
                ],
                "고객유형": "45~55세 첫 프리미엄 차량 구매자",
                "경쟁차종": "벤츠 C클래스 대비 30% 더 저렴한 가격",
                "추천트림": "Standard (2.0T)",
                "트림가격": "3,980만원",
                "추천옵션": "주차 보조 패키지",
                "옵션가격": "70만원",
                "총가격": "4,050만원"
            }
        },
        "IONIQ 6 (CE)": {
            1: {
                "title": "⚡ 미래지향적인 당신을 위한 IONIQ 6 프리미엄 에디션",
                "specs": {
                    "배터리": "77.4kWh",
                    "주행거리": "524km(한국기준)",
                    "출력": "320마력(AWD)",
                    "충전시간": "18분(10~80%, 350kW 충전기 기준)",
                    "가속": "0-100km/h 5.1초"
                },
                "추천이유": [
                    "🌱 **친환경**: CO2 배출량 0g/km",
                    "💨 **고성능**: AWD 사양 시 0-100km/h 5.1초",
                    "🔋 **충전 편의**: 5년 무제한 충전권 제공",
                    "🛠️ **보증**: 배터리 10년/20만km 보증"
                ],
                "고객유형": "기술에 민감한 30대, 환경을 중시하는 전문직 종사자",
                "경쟁차종": "테슬라 모델 3 대비 15% 더 긴 주행거리",
                "추천트림": "Premium (AWD)",
                "트림가격": "6,450만원",
                "추천옵션": "퍼포먼스 패키지",
                "옵션가격": "290만원",
                "총가격": "6,740만원"
            },
            2: {
                "title": "🌿 럭셔리함과 친환경을 동시에! IONIQ 6 익스클루시브",
                "specs": {
                    "배터리": "77.4kWh",
                    "주행거리": "524km",
                    "인테리어": "우드 그레인 + 리사이클드 PET 시트",
                    "특징": "공기 청정 시스템 + 마사지 시트",
                    "충전": "800V 초고속 충전 지원"
                },
                "추천이유": [
                    "🌳 **친환경 럭셔리**: 재생 소재 사용하면서도 고급스러움",
                    "🧘 **웰빙 기능**: 공기 청정 + 마사지 시트로 피로 회복",
                    "🔌 **초고속 충전**: 18분 충전으로 475km 주행 가능",
                    "🎵 **프리미엄 사운드**: 12스피커 BOSE 시스템"
                ],
                "고객유형": "50대 이상 여성, 웰빙 라이프스타일을 추구하는 분",
                "경쟁차종": "메르세데스 EQS 대비 40% 더 저렴한 가격",
                "추천트림": "Exclusive (RWD)",
                "트림가격": "5,780만원",
                "추천옵션": "럭셔리 인테리어 패키지",
                "옵션가격": "240만원",
                "총가격": "6,020만원"
            },
            4: {
                "title": "🚀 디자인 아이콘! IONIQ 6 스포티 에디션",
                "specs": {
                    "배터리": "77.4kWh",
                    "주행거리": "524km",
                    "디자인": "Cd 0.21 초저항 계수",
                    "가속": "0-100km/h 5.1초(AWD)",
                    "특징": "V2L(차량→외부 전력 공급)"
                },
                "추천이유": [
                    "🎨 **혁신적 디자인**: 2023 세계 차량 어워드 수상",
                    "🏎️ **스포티 주행**: 스포츠 서스펜션 + 가상 엔진 사운드",
                    "🏕️ **캠핑 기능**: V2L로 캠핑장에서 전기 사용 가능",
                    "📸 **SNS 친화적**: 인스타그램 필터 연동 기능"
                ],
                "고객유형": "20~30대 젊은 층, 디자인과 기술을 중시하는 분",
                "경쟁차종": "폭스바겔 ID.4 대비 25% 더 나은 공기역학적 디자인",
                "추천트림": "Exclusive (RWD)",
                "트림가격": "5,780만원",
                "추천옵션": "스포츠 서스펜션",
                "옵션가격": "120만원",
                "총가격": "5,900만원"
            }
        },
        "Grandeur (GN7 HEV)": {
            1: {
                "title": "👔 비즈니스 리더를 위한 Grandeur HEV Inspiration",
                "specs": {
                    "엔진": "1.6L 하이브리드",
                    "연비": "17.8km/L",
                    "특징": "VIP 윈터 패키지(열선 스티어링 휠 + 통풍 시트)",
                    "인포테인먼트": "12.3인치 오버헤드 디스플레이",
                    "보증": "5년/10만km"
                },
                "추천이유": [
                    "💼 **비즈니스 최적화**: 후석 만족도를 높인 디자인",
                    "❄️ **한파 대비**: 열선 스티어링 휠 + 통풍 시트",
                    "🌿 **친환경**: 하이브리드 시스템으로 연비 효율",
                    "🏢 **기업용 특혜**: 리스 시 세금 혜택 30%↑"
                ],
                "고객유형": "55~65세 기업 임원층, 전기차 충전 인프라가 부족한 분",
                "경쟁차종": "캐딜락 CT5 하이브리드 대비 15% 더 좋은 연비",
                "추천트림": "Inspiration (HEV)",
                "트림가격": "5,120만원",
                "추천옵션": "VIP 윈터 패키지",
                "옵션가격": "210만원",
                "총가격": "5,330만원"
            },
            2: {
                "title": "💎 건강을 생각하는 당신을 위한 Grandeur HEV Prestige",
                "specs": {
                    "엔진": "1.6L 하이브리드",
                    "시스템": "헬스 케어 패키지(생체 신호 모니터링)",
                    "사운드": "12스피커 렉시컨 사운드",
                    "인테리어": "프리미엄 가죽 시트",
                    "공기청정": "공기 청정 기능 탑재"
                },
                "추천이유": [
                    "❤️ **건강 관리**: 생체 신호 모니터링으로 운전자 건강 체크",
                    "🎶 **사운드**: 렉시컨 사운드로 고급스러운 주행 경험",
                    "🌬️ **공기질**: 공기 청정 시스템으로 실내 환경 최적화",
                    "🛏️ **편안함**: 마사지 시트로 장시간 운전 피로 감소"
                ],
                "고객유형": "건강과 웰빙을 중시하는 50대 여성 고객층",
                "경쟁차종": "렉서스 ES300h 대비 10% 더 저렴한 가격",
                "추천트림": "Prestige (HEV)",
                "트림가격": "5,890만원",
                "추천옵션": "헬스 케어 패키지",
                "옵션가격": "370만원",
                "총가격": "6,260만원"
            }
        },
        "Tucson (NX4 PHEV)": {
            0: {
                "title": "🌿 주말 레저를 위한 Tucson PHEV Standard",
                "specs": {
                    "엔진": "플러그인 하이브리드",
                    "전기주행거리": "44.5km",
                    "연비": "16.4km/L(가솔린 모드)",
                    "트렁크": "589L",
                    "특징": "에코 코스팅 시스템"
                },
                "추천이유": [
                    "⛰️ **레저 활동**: 대용량 트렁크로 캠핑 용품 수납 용이",
                    "🔋 **에너지 효율**: 신호등 구간에서 에너지 25% 더 회수",
                    "💰 **연비 절감**: 주말 레저 활동 시 연료비 부담 감소",
                    "🏌️ **실용성**: 골프/등산 장비 운반에 최적"
                ],
                "고객유형": "45~55세 중년 남성층, 주말 레저 활동을 즐기는 분",
                "경쟁차종": "토요타 RAV4 하이브리드 대비 15% 더 긴 전기주행거리",
                "추천트림": "Standard (PHEV)",
                "트림가격": "4,890만원",
                "추천옵션": "에코 코스팅 시스템",
                "옵션가격": "80만원",
                "총가격": "4,970만원"
            },
            3: {
                "title": "🚛 장거리 출퇴근자에게 추천하는 Tucson PHEV Premium",
                "specs": {
                    "배터리": "13.8kWh",
                    "종합주행거리": "720km",
                    "주행보조": "컴포트 플러스 패키지",
                    "시트": "통풍 시트",
                    "크루즈": "어드밴스드 크루즈 컨트롤"
                },
                "추천이유": [
                    "🛣️ **장거리 최적화**: 최대 720km 종합 주행 거리",
                    "💺 **편안함**: 통풍 시트로 장시간 운전 피로 감소",
                    "🏢 **기업 혜택**: 회사 차량 인센티브와 결합 시 세제 혜택 15%↑",
                    "⏱️ **시간 절약**: 월 2,000km 이상 장거리 출퇴근에 적합"
                ],
                "고객유형": "월 2,000km 이상 장거리 출퇴근을 하는 50대 중반 고객",
                "경쟁차종": "혼다 CR-V 하이브리드 대비 20% 더 긴 종합주행거리",
                "추천트림": "Premium (PHEV)",
                "트림가격": "5,120만원",
                "추천옵션": "컴포트 플러스",
                "옵션가격": "140만원",
                "총가격": "5,260만원"
            },
            4: {
                "title": "💼 실용적이면서 친환경적인 Tucson PHEV Premium",
                "specs": {
                    "전기주행거리": "44.5km",
                    "연비": "16.4km/L",
                    "기능": "V2L(차량→외부 전력 공급)",
                    "인포테인먼트": "10.25인치 디지털 클러스터",
                    "연결성": "애플 카플레이 연동"
                },
                "추천이유": [
                    "🏕️ **캠핑 기능**: V2L로 캠핑장에서 전기 사용 가능",
                    "📱 **스마트 연결**: 애플 카플레이로 편리한 도심 주행",
                    "💰 **경제성**: 5년 무상 충전권(1,000kWh) 제공",
                    "🌱 **친환경**: 주말 레저와 일상 통근을 동시에 해결"
                ],
                "고객유형": "30대 젊은 고빈도 구매자, 현금 구매를 선호하는 분",
                "경쟁차종": "포드 에스케이프 PHEV 대비 10% 더 좋은 연비",
                "추천트림": "Premium (PHEV)",
                "트림가격": "5,120만원",
                "추천옵션": "스타일 패키지",
                "옵션가격": "150만원",
                "총가격": "5,270만원"
            },
            5: {
                "title": "💳 할부 구매자에게 적합한 Tucson PHEV Standard",
                "specs": {
                    "시스템": "스마트 키 시스템(핸드폰 디지털 키)",
                    "충전": "5년 무상 충전권(1,000kWh)",
                    "연비": "16.4km/L",
                    "주행보조": "후방 카메라",
                    "할부": "36개월 무이자"
                },
                "추천이유": [
                    "💵 **할부 혜택**: 36개월 무이자 할부 가능",
                    "🔑 **편의성**: 핸드폰으로 차량 제어 가능",
                    "⚡ **충전 지원**: 5년 무상 충전권으로 초기 비용 절감",
                    "📉 **진입 장벽 낮춤**: PHEV 구매를 고민하는 신규 고객용"
                ],
                "고객유형": "40대 후반 신규 PHEV 구매자, 할부 구매를 원하는 분",
                "경쟁차종": "미쓰비시 아웃랜더 PHEV 대비 15% 더 저렴한 가격",
                "추천트림": "Standard (PHEV)",
                "트림가격": "4,890만원",
                "추천옵션": "스마트 키 시스템",
                "옵션가격": "60만원",
                "총가격": "4,950만원"
            }
        },
        "Santa-Fe (MX5 PHEV)": {
            2: {
                "title": "👨‍👩‍👧‍👦 대가족을 위한 Santa Fe PHEV Calligraphy",
                "specs": {
                    "엔진": "2.5L 가솔린 + 전기",
                    "전기주행거리": "66.9km",
                    "좌석": "7인승",
                    "특징": "캡틴 시트 패키지",
                    "안전": "어린이 카시트 고정 장치"
                },
                "추천이유": [
                    "👶 **가족 친화적**: 어린이 카시트 고정 장치 기본 탑재",
                    "💺 **편안함**: 2열 통풍 시트 + 릴렉션 모드",
                    "🚐 **공간**: 미니밴 대체용으로 적합한 넉넉한 실내",
                    "👨‍👩‍👧‍👦 **다자녀 지원**: 3명 이상 자녀 가정에 최적화"
                ],
                "고객유형": "다자녀(3명 이상) 가정의 30대 후반~40대 여성",
                "경쟁차종": "혼다 오디세이 하이브리드 대비 15% 더 긴 전기주행거리",
                "추천트림": "Calligraphy (PHEV)",
                "트림가격": "6,350만원",
                "추천옵션": "캡틴 시트 패키지",
                "옵션가격": "250만원",
                "총가격": "6,600만원"
            },
            4: {
                "title": "🏡 젊은 가족을 위한 Santa Fe PHEV Premium",
                "specs": {
                    "전기주행거리": "53km",
                    "디자인": "스타일 패키지(20인치 휠)",
                    "편의": "2열 폴딩 테이블",
                    "전원": "12V 전원 포트 4개",
                    "충전": "V2L 기능"
                },
                "추천이유": [
                    "👪 **가족 활동**: 캠핑/피크닉 용품 적재에 적합",
                    "🎨 **디자인**: 20인치 휠로 세련된 외관",
                    "🔌 **전원 공급**: V2L로 캠핑 시 전기 사용 가능",
                    "💰 **연료비 절감**: 전기 모드로 일상 이동 시 연료비 70%↓"
                ],
                "고객유형": "친환경 차량을 원하는 지방 거주 30대 부부",
                "경쟁차종": "폭스바겔 티구안 PHEV 대비 10% 더 긴 전기주행거리",
                "추천트림": "Premium (PHEV)",
                "트림가격": "5,890만원",
                "추천옵션": "스타일 패키지",
                "옵션가격": "150만원",
                "총가격": "6,040만원"
            }
        },
        "NEXO (FE)": {
            1: {
                "title": "🔮 미래 기술을 선도하는 NEXO Premium",
                "specs": {
                    "연료": "수소",
                    "주행거리": "666km(수소 6.33kg 기준)",
                    "기술": "테크 패키지(AR HUD)",
                    "공기청정": "미세먼지 99.9% 제거",
                    "파킹": "리모트 스마트 파킹"
                },
                "추천이유": [
                    "🚀 **첨단 기술**: AR HUD로 혁신적인 주행 경험",
                    "🌫️ **공기 청정**: 실내 미세먼지를 99.9%까지 제거",
                    "💰 **보조금**: 정부 보조금 4,250만원 적용 가능",
                    "⛽ **연료 지원**: 3년 수소 충전 무료 쿠폰 제공"
                ],
                "고객유형": "IT 업계 종사자(25~35세), 미래 기술을 선호하는 분",
                "경쟁차종": "도요타 미라이 대비 15% 더 긴 주행거리",
                "추천트림": "Premium",
                "트림가격": "7,250만원",
                "추천옵션": "테크 패키지",
                "옵션가격": "320만원",
                "총가격": "7,570만원"
            }
        },
        "G90 (HI)": {
            3: {
                "title": "🎩 비즈니스 엘리트를 위한 G90 Prestige",
                "specs": {
                    "엔진": "3.5L 가솔린 터보",
                    "출력": "380마력",
                    "럭셔리": "리무진 패키지",
                    "사운드": "25스피커 뱅앤올룹슨",
                    "제어": "스마트폰 앱으로 뒷좌석 환경 제어"
                },
                "추천이유": [
                    "💼 **비즈니스 최적화**: '이동형 오피스' 컨셉",
                    "🎵 **사운드**: 25스피커 프리미엄 오디오 시스템",
                    "👔 **VIP 서비스**: 전용 기사 교육 프로그램 제공",
                    "📱 **스마트 제어**: 앱으로 뒷좌석 온도/조명/마사지 제어"
                ],
                "고객유형": "고빈도 비즈니스 이동이 많은 50대 이상 기업 대표층",
                "경쟁차종": "메르세데스 S클래스 대비 20% 더 저렴한 가격",
                "추천트림": "Prestige (3.5T)",
                "트림가격": "8,450만원",
                "추천옵션": "리무진 패키지",
                "옵션가격": "490만원",
                "총가격": "8,940만원"
            }
        }
    },
    '기아': {
        "K5": {
            0: {
                "title": "🔥 스포츠 세단을 원한다면 K5 2.5T GT",
                "specs": {
                    "엔진": "2.5L 터보",
                    "출력": "290마력",
                    "가속": "0-100km/h 6.2초",
                    "서스펜션": "스포츠 튜닝",
                    "인테리어": "레드 스티치 가죽 시트"
                },
                "추천이유": [
                    "🏎️ **고성능**: 동급 최강 290마력 출력",
                    "🎮 **주행 재미**: 액티브 사운드 디자인",
                    "🛡️ **안전**: 10에어백 + 주행보조시스템 풀패키지",
                    "💺 **편의**: 12-way 전동 조절 시트"
                ],
                "고객유형": "주말 드라이브를 즐기는 30대 남성",
                "경쟁차종": "현대 쏘나타 N라인 대비 15% 더 강력한 출력",
                "추천트림": "2.5T GT",
                "트림가격": "4,120만원",
                "추천옵션": "스포츠 패키지",
                "옵션가격": "220만원",
                "총가격": "4,340만원"
            },
            2: {
                "title": "🌿 럭셔리한 친환경 주행, K5 HEV 프레스티지",
                "specs": {
                    "시스템": "1.6L 하이브리드",
                    "연비": "18.2km/L",
                    "인테리어": "우드 그레인 + 나파 가죽",
                    "주행보조": "어드밴스드 드라이빙 어시스트",
                    "사운드": "12스피커 JBL"
                },
                "추천이유": [
                    "🌱 **친환경**: 도심 연비 18.2km/L",
                    "🎵 **사운드**: 12스피커 JBL 프리미엄 시스템",
                    "🤖 **자율주행**: 레벨2 자율주행 기능 기본",
                    "🛋️ **편안함**: 통풍 시트 + 공기 청정 시스템"
                ],
                "고객유형": "환경을 중시하는 30대 여성 VIP",
                "경쟁차종": "혼다 어코드 하이브리드 대비 8% 더 좋은 연비",
                "추천트림": "HEV 프레스티지",
                "트림가격": "3,950만원",
                "추천옵션": "테크 패키지",
                "옵션가격": "180만원",
                "총가격": "4,130만원"
            },
            3: {
                "title": "🚀 고성능 세단을 원하는 당신을 위한 K5 2.5T 프리미엄",
                "specs": {
                    "엔진": "2.5L 터보",
                    "변속기": "8단 자동",
                    "가속": "0-100km/h 6.6초",
                    "브레이크": "브렘보 시스템",
                    "클러스터": "12.3인치 3D"
                },
                "추천이유": [
                    "⚡ **가속 성능**: 0-100km/h 6.6초",
                    "🛑 **제동 성능**: 브렘보 브레이크 시스템",
                    "📊 **디스플레이**: 3D 클러스터로 운전 정보 직관적 확인",
                    "🔊 **사운드**: GT 모드 선택 시 레이싱 카 사운드"
                ],
                "고객유형": "고성능 세단을 원하는 30대 초반 남성",
                "경쟁차종": "폭스바겔 아테온 대비 10% 더 빠른 가속",
                "추천트림": "2.5T 프리미엄",
                "트림가격": "4,350만원",
                "추천옵션": "퍼포먼스 패키지",
                "옵션가격": "240만원",
                "총가격": "4,590만원"
            },
            5: {
                "title": "🚘 첫 세단 구매자에게 추천하는 K5 1.6T 디럭스",
                "specs": {
                    "엔진": "1.6L 터보",
                    "출력": "180마력",
                    "안전": "후방 카메라 + 후측방 경고",
                    "인포테인먼트": "10.25인치 내비게이션",
                    "트렁크": "480L"
                },
                "추천이유": [
                    "🆕 **첫 차 특화**: 초보 운전자를 위한 주차 보조 시스템",
                    "📱 **스마트 연결**: 애플 카플레이 기본 지원",
                    "👨‍👩‍👧‍👦 **가족용**: 넉넉한 트렁크(480L)와 2열 공간",
                    "💰 **할부 혜택**: 36개월 무이자 할부 가능"
                ],
                "고객유형": "50대 중반의 첫 세단 구매자",
                "경쟁차종": "현대 쏘나타 대비 15% 더 저렴한 보험료",
                "추천트림": "1.6T 디럭스",
                "트림가격": "2,950만원",
                "추천옵션": "라이트 에디션",
                "옵션가격": "75만원",
                "총가격": "3,025만원"
            }
        },
        "Telluride": {
            0: {
                "title": "⛰️ 오프로드 애호가를 위한 Telluride 프레스티지 AWD",
                "specs": {
                    "엔진": "3.8L V6",
                    "구동": "풀타임 AWD",
                    "휠": "20인치 알로이",
                    "트렁크": "1,597L(최대)",
                    "주행보조": "360도 어라운드 뷰"
                },
                "추천이유": [
                    "🏕️ **오프로드**: 전자식 차동제한장치로 모든 도로 주행 가능",
                    "📦 **수납공간**: 캠핑/레저 장비 수납에 최적",
                    "👨‍👩‍👧‍👦 **대가족**: 8인승 넉넉한 공간",
                    "🔧 **유지보수**: 5년/10만km 무상 서비스"
                ],
                "고객유형": "레저 활동을 즐기는 30대 후반 고소득층",
                "경쟁차종": "포드 익스플로러 대비 10% 더 큰 트렁크",
                "추천트림": "3.8 프레스티지 AWD",
                "트림가격": "6,250만원",
                "추천옵션": "오프로드 패키지",
                "옵션가격": "380만원",
                "총가격": "6,630만원"
            },
            4: {
                "title": "💎 최고급 SUV를 원한다면 Telluride 익스클루시브",
                "specs": {
                    "외관": "메탈릭 페인트 + 다크 크롬 휠",
                    "인테리어": "퀼팅 납파 가죽 시트",
                    "엔터테인먼트": "14.6인치 후석 디스플레이",
                    "사운드": "12스피커 하만카돈",
                    "편의": "전동식 도어 커튼"
                },
                "추천이유": [
                    "✨ **럭셔리**: 최고급 소재와 마감 처리",
                    "🎥 **엔터테인먼트**: 후석 전용 대형 디스플레이",
                    "📞 **VIP 서비스**: 전용 콜센터 지원",
                    "🏢 **비즈니스**: 2열 캡틴 시트로 업무 가능"
                ],
                "고객유형": "50대 중후반 고소득 비즈니스 임원",
                "경쟁차종": "제네시스 GV80 대비 15% 더 저렴한 가격",
                "추천트림": "익스클루시브",
                "트림가격": "6,450만원",
                "추천옵션": "럭셔리 패키지",
                "옵션가격": "280만원",
                "총가격": "6,730만원"
            }
        },
        "Sportage": {
            0: {
                "title": "🏙️ 도심 생활에 최적화된 Sportage 1.6T 프레스티지",
                "specs": {
                    "엔진": "1.6L 터보",
                    "연비": "13.5km/L",
                    "기술": "12.3인치 클러스터 + 빌트인 캠",
                    "안전": "어반 세이프티 패키지",
                    "사운드": "BOSE 프리미엄"
                },
                "추천이유": [
                    "🏢 **도심 최적화**: 컴팩트한 사이즈(4,660mm)로 주차 용이",
                    "📹 **기술**: 빌트인 캠으로 주행 영상 촬영 가능",
                    "🔊 **사운드**: BOSE 시스템으로 고품질 오디오",
                    "🔧 **보증**: 5년 무상 A/S + 10년 파워트레인 보증"
                ],
                "고객유형": "첫 SUV 구매를 고려하는 30대 초반",
                "경쟁차종": "현대 투싼 대비 5% 더 좋은 연비",
                "추천트림": "1.6T 프레스티지",
                "트림가격": "3,450만원",
                "추천옵션": "테크 패키지",
                "옵션가격": "210만원",
                "총가격": "3,660만원"
            },
            3: {
                "title": "📸 SNS 세대를 위한 Sportage 디자인 프리미엄",
                "specs": {
                    "디자인": "20인치 알로이 휠 + 패널 선루프",
                    "기능": "인스타그램 필터 연동",
                    "인테리어": "커스텀 디스플레이",
                    "사운드": "15스피커 하만카돈",
                    "편의": "2열 폴딩 테이블"
                },
                "추천이유": [
                    "📱 **SNS 연동**: 인스타그램 필터로 차량과 라이프스타일 공유",
                    "🎨 **디자인**: GT 라인 전용 스타일링",
                    "🎵 **사운드**: 15스피커 하만카돈 시스템",
                    "🏕️ **캠핑**: 2열 폴딩 테이블로 야외 활동 지원"
                ],
                "고객유형": "디자인을 중시하는 20~30대",
                "경쟁차종": "마즈다 CX-5 대비 10% 더 많은 표준 사양",
                "추천트림": "디자인 프리미엄",
                "트림가격": "3,950만원",
                "추천옵션": "스타일 패키지",
                "옵션가격": "150만원",
                "총가격": "4,100만원"
            }
        },
        "EV9": {
            1: {
                "title": "🌍 ESG 경영을 실천하는 EV9 롱레인지 RWD",
                "specs": {
                    "배터리": "99.8kWh",
                    "주행거리": "501km",
                    "좌석": "2열 캡틴 시트",
                    "충전": "800V 초고속 충전",
                    "특징": "24시간 긴급 출동 서비스"
                },
                "추천이유": [
                    "🌱 **친환경**: 기업 ESG 경영理念과 부합",
                    "💼 **비즈니스**: 2열 캡틴 시트로 업무 가능",
                    "⚡ **충전**: 18분 충전으로 475km 주행 가능",
                    "📞 **서비스**: 전용 콜센터 + 24시간 긴급 출동"
                ],
                "고객유형": "환경 가치를 중시하는 50대 VIP",
                "경쟁차종": "테슬라 모델 X 대비 15% 더 저렴한 가격",
                "추천트림": "롱레인지 RWD",
                "트림가격": "7,890만원",
                "추천옵션": "VIP 패키지",
                "옵션가격": "520만원",
                "총가격": "8,410만원"
            },
            4: {
                "title": "✈️ 해외 출장이 잦은 당신을 위한 EV9 익스클루시브",
                "specs": {
                    "시트": "2열 ottoman 기능",
                    "엔터테인먼트": "27인치 와이드 디스플레이",
                    "편의": "전용 냉장고 + 와인 셀러",
                    "사운드": "18스피커 메르세데스-벤츠 시스템",
                    "서비스": "공항 픽업 서비스"
                },
                "추천이유": [
                    "🛫 **출장 지원**: 공항 픽업 서비스 제공",
                    "🛋️ **편안함**: 2열 ottoman 기능으로 휴식 가능",
                    "🍷 **럭셔리**: 전용 와인 셀러 탑재",
                    "💎 **프리미엄**: 중고차 시장에서 3년차 잔존가율 80%"
                ],
                "고객유형": "해외 출장이 잦은 50대 고위 임원",
                "경쟁차종": "제네시스 GV80 전기차 대비 20% 더 넓은 실내",
                "추천트림": "익스클루시브 6인승",
                "트림가격": "8,250만원",
                "추천옵션": "VIP 컴포트",
                "옵션가격": "480만원",
                "총가격": "8,730만원"
            }
        },
        "Sorento": {
            1: {
                "title": "👪 대가족을 위한 Sorento PHEV 프리미엄",
                "specs": {
                    "시스템": "PHEV",
                    "전기주행거리": "66km",
                    "인테리어": "나파 가죽 시트",
                    "주행보조": "컴포트 플러스 패키지",
                    "공간": "3열 전동 접이식"
                },
                "추천이유": [
                    "🔌 **친환경**: PHEV 시스템으로 연료비 절감",
                    "💺 **편안함**: 통풍 시트로 장거리 운전 피로 감소",
                    "👨‍👩‍👧‍👦 **가족용**: 7인승으로 대가족 이동 가능",
                    "💰 **세제 혜택**: 일반 하이브리드 대비 20% 더 유리"
                ],
                "고객유형": "환경 성향을 가진 50대 VIP",
                "경쟁차종": "토요타 하이랜더 하이브리드 대비 15% 더 긴 전기주행거리",
                "추천트림": "PHEV 프리미엄",
                "트림가격": "5,950만원",
                "추천옵션": "럭셔리 인테리어 패키지",
                "옵션가격": "280만원",
                "총가격": "6,230만원"
            },
            4: {
                "title": "🛣️ 장거리 여행을 좋아하는 당신을 위한 Sorento HEV 프레스티지",
                "specs": {
                    "시스템": "HEV",
                    "연비": "16.7km/L",
                    "시트": "캡틴 시트 패키지",
                    "디스플레이": "12.3인치 클러스터",
                    "휠": "19인치 에어로"
                },
                "추천이유": [
                    "🛣️ **장거리**: 연비 16.7km/L로 경제적",
                    "💺 **승차감**: 2열 캡틴 시트로 편안함 극대화",
                    "🌬️ **공기질**: 공기 청정 모드로 쾌적한 실내 환경",
                    "🔋 **보증**: 10년/20만km 하이브리드 시스템 보증"
                ],
                "고객유형": "주말마다 가족과 여행을 즐기는 50대",
                "경쟁차종": "포드 엣지 하이브리드 대비 10% 더 좋은 연비",
                "추천트림": "HEV 프레스티지",
                "트림가격": "5,450만원",
                "추천옵션": "테크 패키지",
                "옵션가격": "220만원",
                "총가격": "5,670만원"
            }
        },
        "Carnival": {
            1: {
                "title": "👨‍👩‍👧‍👦 다자녀 가정을 위한 Carnival 리무지엄",
                "specs": {
                    "좌석": "11인승",
                    "시트": "2열 회전 기능",
                    "편의": "3열 전동 접이식",
                    "공기청정": "후석 전용",
                    "도어": "오토마틱 슬라이딩"
                },
                "추천이유": [
                    "👶 **육아 지원**: 어린이 승하차 보조 시스템",
                    "🔄 **공간 활용**: 2열 회전으로 차량 내 활동 공간 확보",
                    "🍼 **다자녀**: 유아용 카시트 3개 동시 설치 가능",
                    "🔧 **서비스**: 5년 무상 정기점검"
                ],
                "고객유형": "다자녀 가정의 40~50대 여성",
                "경쟁차종": "혼다 오디세이 대비 15% 더 많은 좌석",
                "추천트림": "리무지엄",
                "트림가격": "5,450만원",
                "추천옵션": "VIP 패키지",
                "옵션가격": "290만원",
                "총가격": "5,740만원"
            }
        },
        "EV6": {
            2: {
                "title": "🏎️ 주행 재미를 원한다면 EV6 GT-Line AWD",
                "specs": {
                    "시스템": "AWD 듀얼 모터",
                    "출력": "320kW",
                    "가속": "0-100km/h 5.1초",
                    "인테리어": "우드 그레인 + 리사이클드 PET",
                    "충전": "800V 초고속"
                },
                "추천이유": [
                    "⚡ **고성능**: 0-100km/h 5.1초의 강력한 가속",
                    "🌳 **친환경**: 재생 소재 사용한 럭셔리 인테리어",
                    "🎮 **게임 연동**: 레이싱 게임과 연동 가능",
                    "💳 **혜택**: 기아카드 포인트 5% 적립"
                ],
                "고객유형": "30대 젊은 여성 VIP",
                "경쟁차종": "테슬라 모델 Y 대비 10% 더 빠른 충전",
                "추천트림": "GT-Line AWD",
                "트림가격": "6,850만원",
                "추천옵션": "프리미엄 인테리어",
                "옵션가격": "320만원",
                "총가격": "7,170만원"
            }
        },
        "Seltos": {
            2: {
                "title": "📱 SNS 세대를 위한 Seltos 1.6T 프레스티지",
                "specs": {
                    "엔진": "1.6L 터보",
                    "출력": "177마력",
                    "연비": "18.1km/L",
                    "기술": "빌트인 캠",
                    "인포테인먼트": "10.25인치 와이드 디스플레이"
                },
                "추천이유": [
                    "📸 **SNS 공유**: 빌트인 캠으로 주행 영상 촬영",
                    "🔊 **사운드**: BOSE 프리미엄 시스템",
                    "🏕️ **캠핑**: 2열 폴딩 테이블로 야외 활동 지원",
                    "💳 **할부**: 36개월 무이자 할부 가능"
                ],
                "고객유형": "20~30대 젊은 여성 VIP",
                "경쟁차종": "현대 코나 대비 8% 더 좋은 연비",
                "추천트림": "1.6T 프레스티지",
                "트림가격": "3,120만원",
                "추천옵션": "프리미엄 사운드",
                "옵션가격": "150만원",
                "총가격": "3,270만원"
            }
        },
        "Tucson(NX4)": {
            3: {
                "title": "🛣️ 장거리 운전자에게 추천하는 Tucson 2.5 프리미엄",
                "specs": {
                    "엔진": "2.5L 가솔린",
                    "변속기": "8단 자동",
                    "주행보조": "하이웨이 드라이빙 어시스트",
                    "연비": "15.8km/L",
                    "클러스터": "12.3인치 파노라마"
                },
                "추천이유": [
                    "🛣️ **장거리**: 차선 유지/차간 거리 자동 조절",
                    "💺 **편안함**: 장시간 운전 피로도 30% 감소",
                    "📊 **디스플레이**: 파노라마 클러스터로 정보 한눈에",
                    "🔧 **보증**: 5년 무상 A/S + 10년 파워트레인 보증"
                ],
                "고객유형": "월 1,500km 이상 장거리 운전하는 30대 남성",
                "경쟁차종": "혼다 CR-V 대비 12% 더 좋은 고속도로 연비",
                "추천트림": "2.5 프리미엄",
                "트림가격": "3,950만원",
                "추천옵션": "스포츠 패키지",
                "옵션가격": "170만원",
                "총가격": "4,120만원"
            }
        },
        "K3": {
            5: {
                "title": "💰 저예산으로 안정적인 K3 1.6 프레스티지",
                "specs": {
                    "엔진": "1.6L 가솔린",
                    "연비": "15.3km/L",
                    "안전": "6에어백 + 긴급 제동",
                    "인포테인먼트": "10.25인치 내비게이션",
                    "트렁크": "475L"
                },
                "추천이유": [
                    "💵 **저렴한 가격**: 동급 대비 합리적인 가격",
                    "🛡️ **안전**: 6에어백으로 기본적인 안전성 확보",
                    "🔧 **유지보수**: 5년 무상 A/S로 관리 비용 절감",
                    "📉 **잔존가율**: 중고차 시장에서 3년차 70% 유지"
                ],
                "고객유형": "50대 중장년, 첫 차 구매자",
                "경쟁차종": "현대 아반떼 대비 10% 더 저렴한 보험료",
                "추천트림": "1.6 프레스티지",
                "트림가격": "2,450만원",
                "추천옵션": "스마트 패키지",
                "옵션가격": "80만원",
                "총가격": "2,530만원"
            }
        },
        "Sonet": {
            5: {
                "title": "🏙️ 도심 생활에 특화된 Sonet 1.2 스마트",
                "specs": {
                    "엔진": "1.2L 가솔린",
                    "전장": "3,995mm(4m 미만)",
                    "연비": "16.5km/L",
                    "기술": "애플 카플레이 연동",
                    "안전": "후방 카메라 + 긴급 제동"
                },
                "추천이유": [
                    "🅿️ **주차 용이**: 초소형 크기로 좁은 골목 주행 최적화",
                    "💰 **저렴한 유지비**: 보험료 월 평균 5만원대",
                    "🏢 **도심 최적화**: 단거리 이동에 적합한 연비",
                    "🔧 **서비스**: 5년 무상 방문정비"
                ],
                "고객유형": "도심 생활을 주로 하는 50대 중장년",
                "경쟁차종": "현대 베뉴 대비 15% 더 작은 크기",
                "추천트림": "1.2 스마트",
                "트림가격": "2,150만원",
                "추천옵션": "어반 패키지",
                "옵션가격": "60만원",
                "총가격": "2,210만원"
            }
        }
    }
}

def display_vehicle_recommendation(brand, model, cluster_id):
    """개선된 차량 추천 정보 표시 함수 - 시각적으로 매력적인 디자인"""
    recommendation = vehicle_recommendations.get(brand, {}).get(model, {}).get(cluster_id, {})
    
    if not recommendation:
        st.warning("이 차량에 대한 추천 정보가 없습니다.")
        return
    
    # 차량 이미지 표시 (가운데 정렬)
    vehicle_image = vehicle_images.get(model, get_abs_path("img/default.png"))
    if vehicle_image.exists():
        col1, col2, col3 = st.columns([1, 6, 1])
        with col2:
            st.image(str(vehicle_image), use_container_width=True)
    else:
        st.warning("차량 이미지를 불러올 수 없습니다.")
    
    # 타이틀 섹션 (카드 스타일)
    with st.container():
        st.markdown(f"""
        <div style="
            background: linear-gradient(135deg, #6e48aa 0%, #9d50bb 100%);
            padding: 20px;
            border-radius: 10px;
            color: white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        ">
            <h2 style="color: white; text-align: center; margin: 0;">{recommendation.get('title', model)}</h2>
        </div>
        """, unsafe_allow_html=True)
    
    st.markdown("<br>", unsafe_allow_html=True)  # 공백 추가
    
    # 2열 레이아웃: 사양과 추천 이유
    col1, col2 = st.columns([1, 2])
    
    with col1:
        # 주요 사양 카드
        with st.expander("🚀 **주요 사양**", expanded=True):
            specs = recommendation.get("specs", {})
            for key, value in specs.items():
                st.markdown(f"""
                <div style="
                    background: #f8f9fa;
                    padding: 12px;
                    border-radius: 8px;
                    margin-bottom: 8px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                ">
                    <strong>{key}</strong>: {value}
                </div>
                """, unsafe_allow_html=True)
        
        # 가격 정보 카드
        with st.expander("💰 **가격 정보**", expanded=True):
            st.markdown(f"""
            <div style="
                background: #f8f9fa;
                padding: 12px;
                border-radius: 8px;
                margin-bottom: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            ">
                <strong>추천 트림</strong>: {recommendation.get('추천트림', '정보 없음')}
            </div>
            """, unsafe_allow_html=True)
            
            st.markdown(f"""
            <div style="
                background: #f8f9fa;
                padding: 12px;
                border-radius: 8px;
                margin-bottom: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            ">
                <strong>트림 가격</strong>: {recommendation.get('트림가격', '정보 없음')}
            </div>
            """, unsafe_allow_html=True)
            
            st.markdown(f"""
            <div style="
                background: #f8f9fa;
                padding: 12px;
                border-radius: 8px;
                margin-bottom: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            ">
                <strong>추천 옵션</strong>: {recommendation.get('추천옵션', '정보 없음')} (+{recommendation.get('옵션가격', '0')})
            </div>
            """, unsafe_allow_html=True)
            
            st.markdown(f"""
            <div style="
                background: #e9f7ef;
                padding: 12px;
                border-radius: 8px;
                margin-bottom: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                border-left: 4px solid #2ecc71;
            ">
                <strong>총 예상 가격</strong>: {recommendation.get('총가격', '정보 없음')}
            </div>
            """, unsafe_allow_html=True)
    
    with col2:
        # 추천 이유 섹션 (아이콘과 함께)
        with st.expander("✨ **추천 이유**", expanded=True):
            reasons = recommendation.get("추천이유", [])
            for reason in reasons:
                # **텍스트** 를 <strong>텍스트</strong>로 바꿔주는 처리
                reason_html = re.sub(r'\*\*(.*?)\*\*', r'<strong>\1</strong>', reason)
                st.markdown(f"""
                <div style="
                    background: #f0f8ff;
                    padding: 12px;
                    border-radius: 8px;
                    margin-bottom: 8px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                    border-left: 4px solid #3498db;
                ">
                    {reason_html}
                </div>
                """, unsafe_allow_html=True)
        
        # 고객 유형 및 경쟁 차종
        with st.expander("🎯 **추천 고객 유형**", expanded=True):
            st.markdown(f"""
            <div style="
                background: #fff4e6;
                padding: 12px;
                border-radius: 8px;
                margin-bottom: 12px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                border-left: 4px solid #e67e22;
            ">
                {recommendation.get('고객유형', '정보 없음')}
            </div>
            """, unsafe_allow_html=True)
            
            st.markdown(f"""
            <div style="
                background: #e8f4f8;
                padding: 12px;
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                border-left: 4px solid #2980b9;
            ">
                <strong>경쟁 차종 비교</strong>: {recommendation.get('경쟁차종', '정보 없음')}
            </div>
            """, unsafe_allow_html=True)
    
    # 차량 상세 정보 링크 (버튼 스타일)
    vehicle_link = vehicle_links.get(brand, {}).get(model, "#")
    st.markdown(f"""
    <div style="text-align: center; margin-top: 20px;">
        <a href="{vehicle_link}" target="_blank" style="
            display: inline-block;
            padding: 12px 24px;
            background: linear-gradient(135deg, #3498db 0%, #2c3e50 100%);
            color: white;
            text-decoration: none;
            border-radius: 30px;
            font-weight: bold;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
            🔗 {model} 공식 사이트에서 자세히 보기
        </a>
    </div>
    """, unsafe_allow_html=True)
    
    # 구분선 추가
    st.markdown("---")

# 모델 로드 함수
def load_models(brand):
    model_dir = Path(__file__).parent.parent / "models_mini1"

    if brand == '현대':
        segment_model_path = model_dir / "gb_model_hs.pkl"
        clustering_model_path = model_dir / "gb_pipeline_hc.pkl"
    elif brand == '기아':
        segment_model_path = model_dir / "gb_model_ks.pkl"
        clustering_model_path = model_dir / "rf_pipeline_kc.pkl"

    if not segment_model_path.exists():
        raise FileNotFoundError(f"[❌ 경고] 세그먼트 모델이 존재하지 않습니다: {segment_model_path}")
    if not clustering_model_path.exists():
        raise FileNotFoundError(f"[❌ 경고] 클러스터링 모델이 존재하지 않습니다: {clustering_model_path}")

    segment_model = joblib.load(segment_model_path)
    clustering_model = joblib.load(clustering_model_path)
    return segment_model, clustering_model

# 예측을 위한 입력값을 처리하는 함수
def run_input_customer_info():
    if "step" not in st.session_state:
        st.session_state["step"] = 1
    brand = st.session_state.get("brand", "현대")
    
    if st.session_state["step"] == 1:
        run_input_step1(brand)
    elif st.session_state["step"] == 2:
        step2_vehicle_selection(brand)
    elif st.session_state["step"] == 3:
        step3_customer_data_storage()

def run_input_step1(brand):
    st.title(f'📋 {brand} 고객 정보 입력')
    segment_model, clustering_model = load_models(brand)
    
    st.info(f"""
            #### {brand} 고객 정보를 입력하고 예측 버튼을 눌러주세요.
            #### 모든 항목은 필수입니다.
            """)

    with st.form(key="customer_info_form"):
        col1, col2 = st.columns([1, 1])
        with col1:
            성별 = st.selectbox("성별 선택", ["남", "여"])
            
            today = datetime.today()
            year_20_years_ago = today.replace(year=today.year - 20)
            if year_20_years_ago.month == 2 and year_20_years_ago.day == 29:
                year_20_years_ago = year_20_years_ago.replace(day=28)
            
            생년월일 = st.date_input("생년월일 입력", min_value=datetime(1900, 1, 1), max_value=year_20_years_ago)
            if 생년월일:
                today = datetime.today()
                연령 = today.year - 생년월일.year - ((today.month, today.day) < (생년월일.month, 생년월일.day))
            
            거래금액 = st.number_input("고객 예산 입력", min_value=10000000, step=1000000)
            구매빈도 = st.number_input("제품 구매 빈도 입력", min_value=1, step=1, value=1)

        with col2:
            차량구분 = st.selectbox("희망 차량 구분 선택", ["준중형 세단", "중형 세단", "대형 세단", "SUV", "픽업트럭"])
            거래방식 = st.selectbox("거래 방식 선택", ["카드", "현금", "계좌이체"])
            구매한제품 = st.selectbox("구입 희망 모델 선택", list(launch_dates[brand].keys()))
            제품구매날짜 = st.date_input("제품 구매 날짜 입력")

        submitted = st.form_submit_button("예측하기")
        if submitted:
            if not (성별 and 생년월일 and 거래금액 and 구매빈도 and 차량구분 and 거래방식 and 구매한제품 and 제품구매날짜):
                st.error("⚠️ 모든 항목을 입력해야 합니다!")
                st.stop()

            today = datetime.today()
            연령 = today.year - 생년월일.year - ((today.month, today.day) < (생년월일.month, 생년월일.day))

            # 세션 상태 저장
            st.session_state.update({
                "성별": 성별,
                "생년월일": 생년월일,
                "거래금액": 거래금액,
                "구매빈도": 구매빈도,
                "차량구분": 차량구분,
                "거래방식": 거래방식,
                "구매한제품": 구매한제품,
                "제품구매날짜": 제품구매날짜,
                "연령": 연령,
                "제품구매빈도": 구매빈도,
                "제품출시년월": launch_dates[brand].get(구매한제품),
                "친환경차": "여" if 구매한제품 in eco_friendly_models[brand] else "부"
            })

            # 1단계: 세그먼트 분류
            segment_input_data = pd.DataFrame([[거래방식, st.session_state["제품출시년월"], 제품구매날짜, 거래금액, 구매빈도]],
                                           columns=['거래 방식', '제품 출시년월', '제품 구매 날짜', '거래 금액', '제품 구매 빈도'])
            
            고객세그먼트 = segment_model.predict(segment_input_data)[0]
            st.session_state["고객세그먼트"] = 고객세그먼트

            # 2단계: 클러스터링 분류
            clustering_input_data = pd.DataFrame([[성별, 차량구분, 거래방식, st.session_state["제품출시년월"], 
                                                 제품구매날짜, 고객세그먼트, st.session_state["친환경차"], 
                                                 연령, 거래금액, 구매빈도]],
                                               columns=['성별', '차량구분', '거래 방식', '제품 출시년월', 
                                                       '제품 구매 날짜', '고객 세그먼트', '친환경차',
                                                       '연령', '거래 금액', '제품 구매 빈도'])
            
            cluster_id = clustering_model.predict(clustering_input_data)[0]
            st.session_state["Cluster"] = cluster_id

            st.session_state["step"] = 2
            st.session_state["recommended_vehicles"] = brand_recommendations[brand].get(cluster_id, [])
            st.rerun()

def step2_vehicle_selection(brand):
    st.title(f"🚗 {brand} 추천 차량 선택")

    # 세션 상태에서 결과 값 가져오기
    st.subheader("📊 고객 분석 결과")
    customer_segment = st.session_state.get("고객세그먼트", "N/A")
    cluster_id = st.session_state.get("Cluster", "N/A")
    age = st.session_state.get("연령", "N/A")
    gender = st.session_state.get("성별", "N/A")
    transaction_amount = st.session_state.get("거래금액", "N/A")
    
    # 결과를 2열 레이아웃으로 표시
    col1, col2 = st.columns(2)
    
    with col1:
        st.metric(label="고객 세그먼트", value=f"세그먼트 {customer_segment}")
        st.metric(label="연령", value=f"{age}세")
        st.metric(label="거래 금액", value=f"{transaction_amount:,}원")
    
    with col2:
        st.metric(label="클러스터", value=f"클러스터 {cluster_id}")
        st.metric(label="성별", value=gender)
        st.metric(label="차량 유형", value=st.session_state.get("차량구분", "N/A"))
    
    st.markdown("---")  # 구분선
    
    # 추천 차량 목록
    recommended_vehicles = st.session_state.get("recommended_vehicles", [])
    구매한제품 = st.session_state.get("구매한제품", "")
    selected_vehicle = st.session_state.get("selected_vehicle", "")

    # 구매한 제품이 추천 리스트에 없으면 추가
    if 구매한제품 and 구매한제품 not in recommended_vehicles:
        recommended_vehicles.append(구매한제품)

    # 차량 선택
    default_vehicle = selected_vehicle or 구매한제품 or (recommended_vehicles[0] if recommended_vehicles else "")
    if default_vehicle in recommended_vehicles:
        default_index = recommended_vehicles.index(default_vehicle)
    else:
        default_index = 0

    selected_vehicle = st.selectbox(
        "구입 희망 차량을 선택하세요",
        recommended_vehicles,
        key="vehicle_select_box",
        index=default_index
    )

    if selected_vehicle:
        # 개선된 차량 추천 정보 표시
        display_vehicle_recommendation(brand, selected_vehicle, cluster_id)
    else:
        st.warning("추천 차량이 없습니다. 다시 예측을 시도해 주세요.")

    # 선택 완료 버튼
    if st.button("선택 완료"):
        vehicle_price = vehicle_prices.get(brand, {}).get(selected_vehicle, 0)
        st.session_state["거래금액"] = vehicle_price
        st.session_state["selected_vehicle"] = selected_vehicle
        st.success(f"{selected_vehicle} 선택 완료! 이제 고객 정보를 저장합니다.")
        st.session_state["step"] = 3
        st.rerun()

def step3_customer_data_storage():
    st.title("📝 고객 정보 입력 및 저장")

    with st.form(key="customer_info_form"):
        이름 = st.text_input("이름")
        휴대폰번호 = st.text_input("휴대폰 번호 입력", placeholder="필수입니다.")
        이메일 = st.text_input("이메일 입력", placeholder="필수입니다.")
        주소 = st.text_input("주소")
        아이디 = st.text_input("아이디")
        가입일 = st.date_input("가입일")

        submit_button = st.form_submit_button("고객정보 저장하기")

        if submit_button:
            # 유효성 검사
            휴대폰번호 = re.sub(r'[^0-9]', '', 휴대폰번호)
            has_error = False

            if not (이름 and 휴대폰번호 and 이메일 and 주소 and 아이디 and 가입일):
                st.error("⚠️ 모든 항목을 입력해야 합니다!")
                has_error = True

            if not re.fullmatch(r"\d{11}", 휴대폰번호):
                st.error("⚠️ 휴대폰 번호는 11자리 숫자여야 합니다. (예: 01012345678)")
                has_error = True

            if "@" not in 이메일 or "." not in 이메일:
                st.error("⚠️ 이메일 주소 형식이 올바르지 않습니다. '@'와 '.'을 포함해야 합니다.")
                has_error = True

            if has_error:
                st.stop()

            # 세션 상태 저장
            st.session_state.update({
                "name": 이름,
                "phone": 휴대폰번호,
                "email": 이메일,
                "address": 주소,
                "id": 아이디,
                "registration_date": 가입일
            })

            # 데이터 저장 로직
            save_customer_data()
            
            # 세션 초기화 및 다음 단계로
            st.session_state["step"] = 1
            time.sleep(2)
            st.rerun()

def save_customer_data():
    """고객 데이터 저장 함수"""
    brand = st.session_state.get("brand", "")
    
    # 필요한 정보 가져오기
    customer_data = {
        "이름": st.session_state.get("name", ""),
        "생년월일": st.session_state.get("생년월일", ""),
        "연령": st.session_state.get("연령", ""),
        "성별": st.session_state.get("성별", ""),
        "휴대폰번호": st.session_state.get("phone", ""),
        "이메일": st.session_state.get("email", ""),
        "주소": st.session_state.get("address", ""),
        "아이디": st.session_state.get("id", ""),
        "가입일": st.session_state.get("registration_date", ""),
        "차량구분": st.session_state.get("차량구분", ""),
        "구매한 제품": st.session_state.get("selected_vehicle", ""),
        "친환경차": "여" if st.session_state.get("selected_vehicle", "") in eco_friendly_models.get(brand, []) else "부",
        "제품 구매 날짜": st.session_state.get("제품구매날짜", ""),
        "거래 금액": st.session_state.get("거래금액", ""),
        "거래 방식": st.session_state.get("거래방식", ""),
        "제품 구매 빈도": st.session_state.get("제품구매빈도", ""),
        "제품 출시년월": st.session_state.get("제품출시년월", ""),
        "고객세그먼트": st.session_state.get("고객세그먼트", ""),
        "Cluster": st.session_state.get("Cluster", "")
    }

    # 데이터프레임 생성
    full_data = pd.DataFrame([customer_data])

    # 파일 저장 경로
    file_path = Path(__file__).parent.parent.parent.parent / "data" / f"{brand}_고객데이터_신규입력용.csv"
    os.makedirs(file_path.parent, exist_ok=True)
    
    # CSV 파일에 저장 (기존 파일이 있으면 추가, 없으면 새로 생성
    full_data.to_csv(file_path, mode='a', header=not file_path.exists(), index=False, encoding='utf-8-sig')

    # 문자 발송
    send_sms_notification()

    # 이메일 발송
    if brand == '현대' or brand == '기아':
        promo_email.send_welcome_email(
            st.session_state.get("email", ""),
            st.session_state.get("name", ""),
            st.session_state.get("id", ""),
            st.session_state.get("registration_date", "")
        )
        st.success("이메일이 성공적으로 발송되었습니다.")

def send_sms_notification():
    """SMS 알림 발송 함수"""
    clicksend_username = st.secrets["CLICKSEND"]["CLICKSEND_USERNAME"]
    clicksend_api_key = st.secrets["CLICKSEND"]["CLICKSEND_API_KEY"]
    to_number = "+82" + st.session_state.get("phone", "")[1:]
    message_body = f"""안녕하세요, {st.session_state.get("name", "")}님! 
{st.session_state.get("brand", "")} 자동차에서 보내드리는 메시지입니다. 
멤버십 가입을 축하드리며, 다양한 혜택과 서비스를 경험해보세요!"""

    try:
        response = requests.post(
            "https://rest.clicksend.com/v3/sms/send",
            headers={
                "Authorization": f"Basic {base64.b64encode(f'{clicksend_username}:{clicksend_api_key}'.encode()).decode()}",
                "Content-Type": "application/json"
            },
            json={"messages": [{"source": "sdk", "body": message_body, "to": to_number}]}
        )
        st.success("문자가 성공적으로 발송되었습니다.")
    except Exception as e:
        st.error("문자 발송에 실패했습니다.")
        print("Error sending SMS:", e)